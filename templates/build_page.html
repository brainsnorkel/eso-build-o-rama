{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block meta_description %}{{ meta_description }}{% endblock %}

{% block content %}
<nav style="margin-bottom: 20px; font-size: 0.9em;">
    <a href="index.html" style="color: #38ef7d; text-decoration: none;">Home</a>
    <span style="color: #666; margin: 0 10px;">/</span>
    <a href="{{ trial_slug }}.html" style="color: #38ef7d; text-decoration: none;">{{ build.trial_name }}</a>
    <span style="color: #666; margin: 0 10px;">/</span>
    <span style="color: #a8edea;">{{ build.boss_name }}</span>
    <span style="color: #666; margin: 0 10px;">/</span>
    <span style="color: #fff;">{{ build.get_display_name() }}</span>
</nav>

<div class="card">
    <h2>{{ build.get_display_name() }}</h2>
    
    <div class="build-info">
        <div class="info-box">
            <div class="label">Trial &amp; Boss</div>
            <div class="value">{{ build.trial_name }} - {{ build.boss_name }}</div>
        </div>
        
        <div class="info-box">
            <div class="label">Model Player</div>
            <div class="value">{{ best_player.dps|format_dps }} DPS</div>
            <div style="font-size: 0.8em; margin-top: 5px;">
                <div>{{ best_player.player_name }} - {{ best_player.character_name }}</div>
                <a href="{{ best_player.player_url }}" target="_blank" style="color: #38ef7d; text-decoration: none; font-size: 0.9em;">
                    View on ESO Logs →
                </a>
            </div>
        </div>
        
        <div class="info-box">
            <div class="label">Mundus</div>
            <div class="value">{{ best_player.mundus or 'Unknown' }}</div>
        </div>
    </div>
</div>

{% if best_player.abilities_bar1 or best_player.abilities_bar2 %}
<div class="card">
    <h3>Ability Bars</h3>
    
    {% if best_player.abilities_bar1 %}
    <h4 style="margin-top: 15px; color: #a8edea;">
        <span class="status-indicator status-online"></span>Bar 1 (Main)
    </h4>
    <div class="abilities-bar">
        {% for ability in best_player.abilities_bar1 %}
        <div class="ability tooltip" data-tooltip="{{ ability.ability_name }}{% if ability.skill_line %} - {{ ability.skill_line }}{% endif %}">
            {% if ability.ability_icon %}
            <img src="../static/icons/{{ ability.ability_icon }}.png" alt="{{ ability.ability_name }}" class="ability-icon">
            {% endif %}
            <div class="ability-name">{{ ability.ability_name or 'Empty' }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if best_player.abilities_bar2 %}
    <h4 style="margin-top: 15px; color: #a8edea;">
        <span class="status-indicator status-online"></span>Bar 2 (Backup)
    </h4>
    <div class="abilities-bar">
        {% for ability in best_player.abilities_bar2 %}
        <div class="ability tooltip" data-tooltip="{{ ability.ability_name }}{% if ability.skill_line %} - {{ ability.skill_line }}{% endif %}">
            {% if ability.ability_icon %}
            <img src="../static/icons/{{ ability.ability_icon }}.png" alt="{{ ability.ability_name }}" class="ability-icon">
            {% endif %}
            <div class="ability-name">{{ ability.ability_name or 'Empty' }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

{% if best_player.gear %}
<div class="card">
    <table>
        <thead>
            <tr>
                <th>Slot</th>
                <th>Set</th>
                <th>Item</th>
                <th>Trait</th>
                <th>Enchantment</th>
            </tr>
        </thead>
        <tbody>
            {% for gear in best_player.gear %}
            {% if gear.slot not in ['backup_necklace', 'backup_ring1'] and gear.slot not in ['slot_14', 'slot_15'] %}
            <tr>
                <td><strong>{{ gear.slot|title }}</strong></td>
                <td>{{ gear.set_name or 'N/A' }}</td>
                <td>
                    {% if gear.slot in ['head', 'chest', 'shoulders', 'belt', 'hands', 'legs', 'feet'] and gear.armor_weight %}
                        {{ gear.item_name or 'N/A' }} ({{ gear.armor_weight }})
                    {% else %}
                        {{ gear.item_name or 'N/A' }}
                    {% endif %}
                </td>
                <td title="Trait ID: {{ gear.trait_id or 'None' }}">{{ gear.trait or 'N/A' }}</td>
                <td title="Enchant ID: {{ gear.enchant_id or 'None' }}">{{ gear.enchantment or 'N/A' }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
    
    <h4 style="margin-top: 20px;">Sets Used</h4>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
        {% for set_name, count in best_player.sets_equipped.items() %}
        <div style="background: rgba(168, 237, 234, 0.1); padding: 8px 15px; border-radius: 5px; border: 1px solid rgba(168, 237, 234, 0.3);">
            {{ set_name }} ({{ count }} pieces)
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if best_player.champion_points %}
<div class="card">
    <h3>Champion Points (Blue)</h3>
    <ul>
        {% for cp in best_player.champion_points %}
        <li>{{ cp }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if build.all_players|length > 1 %}
<div class="card">
    <h3>Other Example Players ({{ build.all_players|length }} total)</h3>
    <table>
        <thead>
            <tr>
                <th>Player</th>
                <th>Character</th>
                <th>DPS</th>
            </tr>
        </thead>
        <tbody>
            {% set unique_players = {} %}
            {% for player in build.all_players|sort(attribute='dps', reverse=True) %}
                {% if player.player_name not in unique_players or player.dps > unique_players[player.player_name].dps %}
                    {% set _ = unique_players.update({player.player_name: player}) %}
                {% endif %}
            {% endfor %}
            {% for player in unique_players.values()|sort(attribute='dps', reverse=True) %}
            <tr>
                <td>
                    <div>{{ player.player_name }}</div>
                    <a href="{{ player.player_url }}" target="_blank" style="color: #38ef7d; text-decoration: none; font-size: 0.8em;">
                        View on ESO Logs →
                    </a>
                </td>
                <td>{{ player.character_name }}</td>
                <td>{{ player.dps|format_dps }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% set unique_players = {} %}
    {% for player in build.all_players %}
        {% if player.player_name not in unique_players or player.dps > unique_players[player.player_name].dps %}
            {% set _ = unique_players.update({player.player_name: player}) %}
        {% endif %}
    {% endfor %}
    {% if unique_players|length > 10 %}
    <p style="margin-top: 10px; color: #7f8c8d; font-style: italic;">
        Showing top 10 of {{ unique_players|length }} unique players ({{ build.all_players|length }} total entries)
    </p>
    {% elif unique_players|length != build.all_players|length %}
    <p style="margin-top: 10px; color: #7f8c8d; font-style: italic;">
        {{ unique_players|length }} unique players ({{ build.all_players|length }} total entries)
    </p>
    {% endif %}
</div>
{% endif %}
{% endblock %}
