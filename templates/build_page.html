{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block meta_description %}{{ meta_description }}{% endblock %}

{% block og_type %}article{% endblock %}

{% block og_title %}@{{ best_player.player_name }} - {{ build.get_display_name() }} - {{ build.trial_name }} {{ build.boss_name }}{% endblock %}

{% block og_description %}{{ build.get_display_name() }} build achieving {{ best_player.dps|format_dps }} DPS in {{ build.trial_name }} {{ build.boss_name }} by {{ best_player.player_name }}. View detailed gear, abilities, and champion points.{% endblock %}

{% block og_image_alt %}{{ build.get_display_name() }} build for {{ build.trial_name }} {{ build.boss_name }} - {{ best_player.dps|format_dps }} DPS{% endblock %}

{% block twitter_title %}@{{ best_player.player_name }} - {{ build.get_display_name() }} - {{ build.trial_name }} {{ build.boss_name }}{% endblock %}

{% block twitter_description %}{{ build.get_display_name() }} build achieving {{ best_player.dps|format_dps }} DPS in {{ build.trial_name }} {{ build.boss_name }} by {{ best_player.player_name }}.{% endblock %}

{% block twitter_image_alt %}{{ build.get_display_name() }} build for {{ build.trial_name }} {{ build.boss_name }} - {{ best_player.dps|format_dps }} DPS{% endblock %}

{% block content %}
<nav aria-label="Breadcrumb" style="margin-bottom: 20px; font-size: 0.9em;">
    <ol style="list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; align-items: center;">
        <li style="display: flex; align-items: center;">
            <a href="index.html" style="color: #38ef7d; text-decoration: none;">Home</a>
            <span style="color: #666; margin: 0 10px;" aria-hidden="true">/</span>
        </li>
        <li style="display: flex; align-items: center;">
            <a href="{{ trial_slug }}.html" style="color: #38ef7d; text-decoration: none;">{{ build.trial_name }}</a>
            <span style="color: #666; margin: 0 10px;" aria-hidden="true">/</span>
        </li>
        <li style="display: flex; align-items: center;">
            <span style="color: #a8edea;">{{ build.boss_name }}</span>
            <span style="color: #666; margin: 0 10px;" aria-hidden="true">/</span>
        </li>
        <li>
            <span style="color: #fff;" aria-current="page">{{ build.get_display_name() }}</span>
        </li>
    </ol>
</nav>

<div class="card">
    <h2>{{ build.get_display_name() }}</h2>
    
    <div class="build-info">
        <div class="info-box">
            <div class="label">Trial &amp; Boss</div>
            <div class="value">{{ build.trial_name }} - {{ build.boss_name }}</div>
        </div>
        
        <div class="info-box">
            <div class="label">Model Player</div>
            <div class="value">{{ best_player.dps|format_dps }} DPS</div>
            <div style="font-size: 0.8em; margin-top: 5px;">
                <div>{{ best_player.player_name }} - {{ best_player.character_name }}</div>
                <a href="{{ best_player.player_url }}" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   style="color: #38ef7d; text-decoration: none; font-size: 0.9em;"
                   aria-label="View {{ best_player.player_name }}'s character {{ best_player.character_name }} on ESO Logs">
                    View on ESO Logs →
                </a>
            </div>
        </div>
        
        <div class="info-box">
            <div class="label">Mundus</div>
            <div class="value">{{ best_player.mundus or 'Unknown' }}</div>
        </div>
    </div>
</div>

{% if best_player.abilities_bar1 or best_player.abilities_bar2 %}
<div class="card">
    <h3>Ability Bars</h3>
    
    {% if best_player.abilities_bar1 %}
    <h4 style="margin-top: 15px; color: #a8edea;">
        <span class="status-indicator status-online" aria-hidden="true"></span>Bar 1 (Main)
    </h4>
    <div class="abilities-bar">
        {% for ability in best_player.abilities_bar1 %}
        <div class="ability">
            {% if ability.ability_icon %}
            <img src="../static/icons/{{ ability.ability_icon }}.png" 
                 alt="{{ ability.ability_name }}{% if ability.skill_line %} from {{ ability.skill_line }}{% endif %}" 
                 class="ability-icon">
            {% endif %}
            <div class="ability-name">{{ ability.ability_name or 'Empty' }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if best_player.abilities_bar2 %}
    <h4 style="margin-top: 15px; color: #a8edea;">
        <span class="status-indicator status-online" aria-hidden="true"></span>Bar 2 (Backup)
    </h4>
    <div class="abilities-bar">
        {% for ability in best_player.abilities_bar2 %}
        <div class="ability">
            {% if ability.ability_icon %}
            <img src="../static/icons/{{ ability.ability_icon }}.png" 
                 alt="{{ ability.ability_name }}{% if ability.skill_line %} from {{ ability.skill_line }}{% endif %}" 
                 class="ability-icon">
            {% endif %}
            <div class="ability-name">{{ ability.ability_name or 'Empty' }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

{% if best_player.gear %}
<div class="card">
    <h3>Gear</h3>
    <table>
        <caption class="sr-only">Equipped gear and sets for {{ best_player.character_name }}</caption>
        <thead>
            <tr>
                <th scope="col">Slot</th>
                <th scope="col">Set</th>
                <th scope="col">Item</th>
                <th scope="col">Trait</th>
                <th scope="col">Enchantment</th>
            </tr>
        </thead>
        <tbody>
            {% for gear in best_player.gear %}
            {% if gear.slot not in ['backup_necklace', 'backup_ring1'] and gear.slot not in ['slot_14', 'slot_15'] %}
            <tr>
                <td data-label="Slot"><strong>{{ gear.slot|title }}</strong></td>
                <td data-label="Set">{{ gear.set_name or 'N/A' }}</td>
                <td data-label="Item">
                    {% if gear.slot in ['head', 'chest', 'shoulders', 'belt', 'hands', 'legs', 'feet'] and gear.armor_weight %}
                        {{ gear.item_name or 'N/A' }} ({{ gear.armor_weight }})
                    {% else %}
                        {{ gear.item_name or 'N/A' }}
                    {% endif %}
                </td>
                <td data-label="Trait" title="Trait ID: {{ gear.trait_id or 'None' }}">{{ gear.trait or 'N/A' }}</td>
                <td data-label="Enchantment" title="Enchant ID: {{ gear.enchant_id or 'None' }}">{{ gear.enchantment or 'N/A' }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
    
    <h4 style="margin-top: 20px;">Sets Used</h4>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
        {% for set_name, count in best_player.sets_equipped.items() %}
        <div style="background: rgba(168, 237, 234, 0.1); padding: 8px 15px; border-radius: 5px; border: 1px solid rgba(168, 237, 234, 0.3);">
            {{ set_name }} ({{ count }} pieces)
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if best_player.champion_points %}
<div class="card">
    <h3>Champion Points (Blue)</h3>
    <ul>
        {% for cp in best_player.champion_points %}
        <li>{{ cp }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if build.all_players|length > 1 %}
<div class="card">
    <h3>Other Example Players ({{ build.all_players|length }} total)</h3>
    <table>
        <caption class="sr-only">Other players using this build</caption>
        <thead>
            <tr>
                <th scope="col">Player</th>
                <th scope="col">Character</th>
                <th scope="col">DPS</th>
            </tr>
        </thead>
        <tbody>
            {% set unique_players = {} %}
            {% for player in build.all_players|sort(attribute='dps', reverse=True) %}
                {% if player.player_name not in unique_players or player.dps > unique_players[player.player_name].dps %}
                    {% set _ = unique_players.update({player.player_name: player}) %}
                {% endif %}
            {% endfor %}
            {% for player in unique_players.values()|sort(attribute='dps', reverse=True) %}
            <tr>
                <td data-label="Player">
                    <div>{{ player.player_name }}</div>
                    <a href="{{ player.player_url }}" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       style="color: #38ef7d; text-decoration: none; font-size: 0.8em;"
                       aria-label="View {{ player.player_name }}'s report on ESO Logs">
                        View on ESO Logs →
                    </a>
                </td>
                <td data-label="Character">{{ player.character_name }}</td>
                <td data-label="DPS">{{ player.dps|format_dps }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% set unique_players = {} %}
    {% for player in build.all_players %}
        {% if player.player_name not in unique_players or player.dps > unique_players[player.player_name].dps %}
            {% set _ = unique_players.update({player.player_name: player}) %}
        {% endif %}
    {% endfor %}
    {% if unique_players|length > 10 %}
    <p style="margin-top: 10px; color: #7f8c8d; font-style: italic;">
        Showing top 10 of {{ unique_players|length }} unique players ({{ build.all_players|length }} total entries)
    </p>
    {% elif unique_players|length != build.all_players|length %}
    <p style="margin-top: 10px; color: #7f8c8d; font-style: italic;">
        {{ unique_players|length }} unique players ({{ build.all_players|length }} total entries)
    </p>
    {% endif %}
</div>
{% endif %}
{% endblock %}
